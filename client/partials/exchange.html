<div ng-if="!exchange">This exchange does not exist</div>
<div ng-show="error.message" class="alert alert-danger">{{error.message}}</div>

<div class="container-fluid content exchangeContainer" ng-if="exchange && otherUser && user">

    <div class="row" id="exchangeStages">
        
        <a ng-click="showDiv='negotiate'" class="exchangeStageButton">
            <div class="col-xs-4">1. Negotiate<span ng-if="exchange.status=='Agreed' || exchange.status=='Completed'"> (Done!)</span></div>
        </a>
        <a ng-click="exchange.status=='Agreed' ? showDiv='swap' : alert('Negotiate first')" class="exchangeStageButton">
            <div class="col-xs-4">2. Meet and swap<span ng-if="exchange.status=='Completed'"> (Done!)</span></div>
        </a>
        <a ng-click="exchange.status=='Completed' ? showDiv='feedback' : alert('Complete first')" class="exchangeStageButton">
            <div class="col-xs-4">3. Leave feedback</div>
        </a>

    </div>


    <div class="row" id="exchangeItems" ng-if="showDiv==='negotiate'">



        <div class="col-xs-2" id="myItems" ng-if="exchange.status=='In progress'">
            <h4><a href="/myItems">Your items</a></h4>

            <div ng-if="userIsSender">
                <div ng-repeat="item in options.sender">
                    <a ng-click="addToExchange(item)"><div class="item">{{item.name}}</div></a>
                </div>
            </div>

            <div ng-if="!userIsSender">
                <div ng-repeat="item in options.recipient">
                    <a ng-click="addToExchange(item)"><div class="item">{{item.name}}</div></a>
                </div>
            </div>

        </div>

        <div class="col-xs-2" ng-if="exchange.status!='In progress'"></div>



        <div class="col-xs-8" id="exchange">
            <div class="row"><h5>Exchange - {{exchange.status}}</h5></div>
            <div class="row">

                <div class="col-xs-6" id="myExchangeItems">

                        <h3><a href="/profile">{{ UtilityService.getUserName( user ) }}</a></h3>

                        <div ng-if="userIsSender">
                            <div ng-repeat="item in exchange.items.sender">

                                <a ng-if="exchange.status=='In progress'" ng-click="removeFromExchange(item)">
                                    <div class="exchangeItem">{{ item.name }}</div>
                                </a> 
                                <a ng-if="exchange.status!='In progress'">
                                    <div class="exchangeItem">{{ item.name }}</div>
                                </a> 

                            </div>
                        </div>

                        <div ng-if="!userIsSender">
                            <div ng-repeat="item in exchange.items.recipient">


                                <a ng-if="exchange.status=='In progress'" ng-click="removeFromExchange(item)">
                                    <div class="exchangeItem">{{ item.name }}</div>
                                </a>
                                <a ng-if="exchange.status!='In progress'">
                                    <div class="exchangeItem">{{ item.name }}</div>
                                </a>  

                            </div>
                        </div>
                </div>

                <div class="col-xs-6" id="theirExchangeItems">

                        <h3><a href="/users/{{ otherUser._id }}">{{ UtilityService.getUserName( otherUser ) }}</a></h3>

                        <div ng-if="!userIsSender">
                            <div ng-repeat="item in exchange.items.sender">

                                <a ng-click="removeFromExchange(item)" ng-if="exchange.status=='In progress'">
                                    <div class="exchangeItem">{{ item.name }}</div>
                                </a>
                                <a ng-if="exchange.status!='In progress'">
                                    <div class="exchangeItem">{{ item.name }}</div>
                                </a> 

                            </div>
                        </div>

                        <div ng-if="userIsSender">
                            <div ng-repeat="item in exchange.items.recipient">

                                <a ng-click="removeFromExchange(item)" ng-if="exchange.status=='In progress'">
                                    <div class="exchangeItem">{{ item.name }}</div>
                                </a>  
                                <a ng-if="exchange.status!='In progress'">
                                    <div class="exchangeItem">{{ item.name }}</div>
                                </a>     

                            </div>
                        </div>

                </div>

            </div><!-- row -->




            <div class="row" id="exchangeDecision" ng-if="exchange.status=='In progress'">

                <div ng-if="userIsSender">

                    <div class="col-xs-6">
                        <label>
                            <input type="checkbox" ng-model="exchange.accepted.sender" ng-click="toggleAcceptance()">
                        </label>
                    </div>

                    <div class="col-xs-6">
                        <label>
                            <input type="checkbox" ng-model="exchange.accepted.recipient" disabled="disabled">
                        </label>
                    </div>

                </div>

                <div ng-if="!userIsSender">

                    <div class="col-xs-6">
                        <label>
                            <input type="checkbox" ng-model="exchange.accepted.recipient" ng-click="toggleAcceptance()">
                        </label>
                    </div>

                    <div class="col-xs-6">
                        <label>
                            <input type="checkbox" ng-model="exchange.accepted.sender" disabled="disabled">
                        </label>
                    </div>

                </div>

                <div class="col-xs-12">
                    <button type="button" class="btn btn-outline-danger" ng-click="cancelExchange()">Cancel exchange</button>
                </div>

            </div>



        </div><!-- exchange -->


        <div class="col-xs-2" id="theirItems" ng-if="exchange.status=='In progress'">

                <h4><a href="/users/{{ otherUser._id }}">{{ UtilityService.getUserName( otherUser ) }}'s items</a></h4>

                <div ng-if="userIsSender">
                    <div ng-repeat="item in options.recipient">
                        <a ng-click="addToExchange(item)"><div class="item">{{item.name}}</div></a>
                    </div>
                </div>

                <div ng-if="!userIsSender">
                    <div ng-repeat="item in options.sender">
                        <a ng-click="addToExchange(item)"><div class="item">{{item.name}}</div></a>
                    </div>
                </div>

        </div>



    </div><!-- negotiateDiv -->

    <div ng-if="showDiv==='swap'">

        Go meet them and swap!!

    </div>    




    <div ng-if="showDiv==='feedback'">

        <div class="row"><h5>Feedback</h5></div>
    
        <div id="feedbackForm" class="row" ng-show="!feedbackSubmitted.timestamp">

            How did you rate the experience of this exchange?
            <table id="feedbackTable">
                <tr><th>0 - Bad</th><th>1 - Neutral</th><th>2 - Good</th></tr>
                <tr>
                    <td><input type="radio" name="feedbackRating" value="0" ng-model="feedback.rating"></td>
                    <td><input type="radio" name="feedbackRating" value="1" ng-model="feedback.rating"></td>
                    <td><input type="radio" name="feedbackRating" value="2" ng-model="feedback.rating"></td>
                </tr>
            </table>

           
            <input type="text" id="messageInput" placeholder="Type a message" ng-model="feedback.comment"/><br>

            <button class="btn" id="messageButton" ng-click="submitFeedback( )">Submit Feedback</button>
        </div>

        <div class="row" ng-show="feedbackSubmitted.timestamp">
            Thanks, feedback submitted!<br><br>

            Rating: {{ feedbackSubmitted.rating }}<br>
            Comment: {{ feedbackSubmitted.comment }}<br><br>

        </div>

    </div>


</div>




<div id="exchangeFooter" class="row">

    <div class="col-xs-6" id="messenger">

        <div class="row"><h5>Messages</h5></div>

        <div id="displayMessages">

            <div class="row message" ng-repeat="messageToDisplay in exchange.conversation.messages  | orderBy : '-timestamp'">

                    <div class="col-xs-5 messageInfo" ng-if="messageToDisplay.timestamp">[{{ UtilityService.formatTimestamp(messageToDisplay.timestamp, 'short') }}] <b>{{ UtilityService.getUserName( messageToDisplay.sender ) }}:</b> </div>
                    <div class="col-xs-7 messageContent">{{ messageToDisplay.content }}</div>  

            </div>

        </div>
    

        <div id="messageForm" class="row">
            <input type="text" id="messageInput" placeholder="Type a message" 
            ng-model="message" ng-keydown="$event.keyCode === 13 && sendMessage()" ng-required="true"/>

            <button class="btn" id="messageButton" ng-click="sendMessage( )">Send</button>
        </div>

    </div>


    <div class="col-xs-6" id="otherUserInfo" ng-if="otherUser">

        <div class="row"><h5><a href="/users/{{ otherUser._id }}">{{ UtilityService.getUserName( otherUser ) }}'s details</a></h5></div>
        Feedback score: <b>{{ otherUser.feedback.score }}%</b> ({{ otherUser.feedback.count }} completed exchanges)
        
        <br><br>

        <div id="displayFeedback">

            <div class="row feedback" ng-repeat="feedbackToDisplay in otherUserFeedbacks  | orderBy : '-timestamp'">

                <div class="col-xs-5 messageInfo" ng-if="feedbackToDisplay.timestamp">[{{ UtilityService.formatTimestamp(feedbackToDisplay.timestamp, 'short') }}] <b>{{ UtilityService.getUserName( feedbackToDisplay.author ) }}:</b> </div>
                <div class="col-xs-7 messageContent">{{ feedbackToDisplay.rating }} - {{ feedbackToDisplay.comment }}</div>  

            </div>

        </div>

    </div>

</div>